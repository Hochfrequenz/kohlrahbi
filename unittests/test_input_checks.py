import pytest  # type:ignore[import]

from kohlrahbi import get_valid_pruefis


@pytest.mark.parametrize(
    "input_pruefis, expected_pruefis, known_pruefis",
    [
        pytest.param(
            {"11042": "filename", "13007": "filename"},
            {"11042": "filename", "13007": "filename"},
            None,
            id="only valid pruefis",
        ),
        pytest.param(
            {"01042": "filename", "13007": "filename"},
            {"13007": "filename"},
            None,
            id="invalid pruefi: leading zero",
        ),
        pytest.param(
            {"1042": "filename", "13007": "filename"},
            {"13007": "filename"},
            None,
            id="invalid pruefi: only four digits",
        ),
        pytest.param(
            {"abc": "filename", "13007": "filename"},
            {"13007": "filename"},
            None,
            id="invalid pruefi: characters",
        ),
        pytest.param(
            {"abc": "filename"},
            {},
            None,
            id="invalid pruefi: empty result",
        ),
        pytest.param(
            {"11*": "filename"},
            {"11001": "filename", "11002": "filename", "11003": "filename"},
            [
                "11001",
                "11002",
                "11003",
                "12001",
                "12002",
                "12003",
                "13001",
                "13002",
                "13003",
            ],
            id="wildcard `*` at end",
        ),
        pytest.param(
            {"*1": "filename"},
            {"11001": "filename", "12001": "filename", "13001": "filename"},
            [
                "11001",
                "11002",
                "11003",
                "12001",
                "12002",
                "12003",
                "13001",
                "13002",
                "13003",
            ],
            id="wildcard `*` at begin",
        ),
        pytest.param(
            {"11*1": "filename"},
            {"11001": "filename"},
            [
                "11001",
                "11002",
                "11003",
                "12001",
                "12002",
                "12003",
                "13001",
                "13002",
                "13003",
            ],
            id="wildcard `*` in the middle",  # who should seriously want this?
        ),
        pytest.param(
            {"?1001": "filename"},
            {"11001": "filename", "21001": "filename", "31001": "filename"},
            ["11001", "11002", "11003", "12002", "12003", "13003", "21001", "31001"],
            id="wildcard `?` at begin",
        ),
        pytest.param(
            {"11?42": "filename"},
            {"11042": "filename", "11142": "filename"},
            [
                "11001",
                "11002",
                "11003",
                "11042",
                "11142",
                "12001",
                "12002",
                "12003",
                "13001",
                "13002",
                "13003",
            ],
            id="wildcard `?` in the middle",
        ),
        pytest.param(
            {"1100?": "filename"},
            {
                "11001": "filename",
                "11002": "filename",
                "11003": "filename",
                "11004": "filename",
                "11005": "filename",
                "11006": "filename",
                "11007": "filename",
                "11008": "filename",
                "11009": "filename",
            },
            [
                "11001",
                "11002",
                "11003",
                "11004",
                "11005",
                "11006",
                "11007",
                "11008",
                "11009",
                "11042",
                "11142",
                "12001",
                "12002",
                "12003",
                "13001",
                "13002",
                "13003",
            ],
            id="wildcard `?` at the end",
        ),
        pytest.param(
            {"110??": "filename"},
            {
                "11001": "filename",
                "11002": "filename",
                "11003": "filename",
                "11004": "filename",
                "11005": "filename",
                "11006": "filename",
                "11007": "filename",
                "11008": "filename",
                "11009": "filename",
                "11010": "filename",
                "11042": "filename",
            },
            [
                "11001",
                "11002",
                "11003",
                "11004",
                "11005",
                "11006",
                "11007",
                "11008",
                "11009",
                "11010",
                "11042",
                "11142",
                "12001",
                "12002",
                "12003",
                "13001",
                "13002",
                "13003",
            ],
            id="wildcard `??` at the end",
        ),
        pytest.param(
            {"*00?": "filename"},
            {
                "11001": "filename",
                "11002": "filename",
                "11003": "filename",
                "11004": "filename",
                "11005": "filename",
                "11006": "filename",
                "11007": "filename",
                "11008": "filename",
                "11009": "filename",
                "12001": "filename",
                "12002": "filename",
                "12003": "filename",
                "13001": "filename",
                "13002": "filename",
                "13003": "filename",
            },
            [
                "11001",
                "11002",
                "11003",
                "11004",
                "11005",
                "11006",
                "11007",
                "11008",
                "11009",
                "11010",
                "11042",
                "11142",
                "12001",
                "12002",
                "12003",
                "13001",
                "13002",
                "13003",
            ],
            id="wildcard combination `*` and `?`",
        ),
    ],
)
def test_get_only_valid_pruefis(
    input_pruefis: dict[str, str | None], expected_pruefis: dict[str, str], known_pruefis: list[str] | None
):
    valid_pruefis = get_valid_pruefis(pruefi_to_file_mapping=input_pruefis, all_known_pruefis=known_pruefis)
    assert valid_pruefis == expected_pruefis
